# Section 3: Advanced Inventory Techniques

In this section, we’ll explore advanced techniques for managing Ansible inventory. These techniques are essential when dealing with complex environments, dynamic infrastructures, and custom requirements that go beyond the capabilities of standard static and dynamic inventories.

## Dynamic Inventories: Integrating with Cloud Providers and CMDBs

Dynamic inventories allow Ansible to adapt to changes in your infrastructure automatically. This is especially useful in cloud environments, where instances and resources are often ephemeral. Here’s how you can leverage dynamic inventories effectively:

### 1. Cloud Provider Integrations with AWS

Ansible provides a built-in `aws_ec2` inventory plugin that allows you to dynamically generate an inventory based on your AWS infrastructure. This plugin queries AWS to discover EC2 instances, filters them based on tags or other criteria, and automatically groups them in your inventory.

### Full Example: Using the AWS EC2 Plugin

Here’s a step-by-step example of how to set up and use the `aws_ec2` plugin for dynamic inventory with AWS:

#### Step 1: Install the Required Packages

Ensure you have the required packages installed. You need `boto3` and `botocore` to interact with the AWS API:

```bash
pip install boto3 botocore
```

#### Step 2: Configure AWS Credentials

Ensure that your AWS credentials are configured. This can be done by setting up the `~/.aws/credentials` file or by exporting the credentials as environment variables:

```bash
export AWS_ACCESS_KEY_ID='your-access-key-id'
export AWS_SECRET_ACCESS_KEY='your-secret-access-key'
export AWS_DEFAULT_REGION='us-east-1'
```

Alternatively, you can use the AWS CLI to configure your credentials:

```bash
aws configure
```

#### Step 3: Create the Dynamic Inventory Configuration File

Create a configuration file for the `aws_ec2` plugin. Save this file as `aws_ec2.yml` in your inventory directory:

```yaml
plugin: aws_ec2
regions:
  - us-east-1
filters:
  tag:Environment: production
keyed_groups:
  - key: tags.Name
    prefix: instance_name_
hostnames:
  - tag:Name
compose:
  ansible_host: public_ip_address
  ansible_user: ec2-user
```

- **regions**: Specifies the AWS regions to query. In this example, it's `us-east-1`.
- **filters**: Filters the EC2 instances by tags, such as `Environment: production`.
- **keyed_groups**: Creates Ansible groups based on the instance tags.
- **hostnames**: Defines which attribute of the EC2 instance to use as the hostname. Here, it's the `Name` tag.
- **compose**: Maps AWS attributes to Ansible variables. In this example, it maps the EC2 `public_ip_address` to `ansible_host` and sets `ansible_user` to `ec2-user`.

#### Step 4: Running the Ansible Playbook with Dynamic Inventory

You can now run your Ansible playbook using the dynamic inventory you’ve just configured:

```bash
ansible-playbook -i aws_ec2.yml site.yml
```

This command will execute the playbook `site.yml` using the dynamically generated inventory from AWS. Ansible will automatically discover and target the EC2 instances that match the criteria specified in your `aws_ec2.yml` configuration file.

#### Step 5: Verifying the Inventory

You can also list and verify the inventory generated by the `aws_ec2` plugin without running a playbook:

```bash
ansible-inventory -i aws_ec2.yml --list
```

This command will output the full inventory in JSON format, showing how the EC2 instances are grouped and which variables are assigned.
### 2. CMDB Integrations
For organizations with a CMDB (Configuration Management Database), integrating it with Ansible ensures that your inventory is always in sync with your infrastructure’s official records.

- **ServiceNow Example**:
  - Using a ServiceNow plugin, you can query CMDB records to create an inventory dynamically:
  ```yaml
  plugin: servicenow
  instance: your_instance
  username: your_username
  password: your_password
  filters:
    operational_status: 1
  ```

## Creating Custom Dynamic Inventory Scripts

While built-in plugins cover many scenarios, there may be cases where you need a custom dynamic inventory script. These scripts can be written in Python or any language that outputs JSON.

# Creating Custom Dynamic Inventory Scripts

While built-in plugins cover many scenarios, there may be cases where you need a custom dynamic inventory script. These scripts can be written in Python or any language that outputs JSON. Custom scripts are particularly useful when dealing with specialized environments or systems that aren’t directly supported by Ansible’s existing inventory plugins.

## Example: Custom Script for Docker Containers

Here’s a basic example of a custom dynamic inventory script that lists Docker containers as hosts. This script queries Docker to list all running containers and returns them as an Ansible inventory.

```python
#!/usr/bin/env python

import subprocess
import json

def list_containers():
    # Use Docker CLI to list all running container names
    result = subprocess.run(['docker', 'ps', '--format', '{{.Names}}'], stdout=subprocess.PIPE)
    containers = result.stdout.decode('utf-8').strip().split('\n')
    return containers

def generate_inventory():
    # Generate inventory structure expected by Ansible
    containers = list_containers()
    inventory = {
        "all": {
            "hosts": containers,
            "vars": {
                "ansible_connection": "docker"
            }
        }
    }
    return inventory

if __name__ == "__main__":
    # Print the inventory in JSON format
    print(json.dumps(generate_inventory(), indent=2))
```

## Step-by-Step Guide to Using the Custom Dynamic Inventory Script

### Step 1: Save the Script

First, you need to save the script to a file in your Ansible project directory. Let’s assume you save it as `docker_inventory.py`.

```bash
touch docker_inventory.py
chmod +x docker_inventory.py
```

- **`docker_inventory.py`**: The name of your custom inventory script. You can choose any name as long as it’s executable and outputs JSON in the correct format.
- **`chmod +x`**: This command makes the script executable.

### Step 2: Test the Script

Before integrating the script with Ansible, you should test it to ensure it works correctly. Run the script directly from the command line:

```bash
./docker_inventory.py
```

This should output the inventory in JSON format. For example, if you have two running Docker containers named `web01` and `db01`, the output might look like this:

```json
{
  "all": {
    "hosts": [
      "web01",
      "db01"
    ],
    "vars": {
      "ansible_connection": "docker"
    }
  }
}
```

### Step 3: Use the Script with Ansible

To use the custom script as a dynamic inventory in Ansible, simply reference it in the `ansible-playbook` command using the `-i` option:

```bash
ansible-playbook -i ./docker_inventory.py playbook.yml
```

Here’s what’s happening:

- **`-i ./docker_inventory.py`**: Specifies the inventory to use. Ansible will execute the `docker_inventory.py` script, which will output the inventory in JSON format.
- **`playbook.yml`**: The playbook you want to run against the Docker containers.

### Step 4: Integrate with Ansible Configuration

If you plan to use this dynamic inventory script regularly, you can integrate it into your Ansible configuration. Modify your `ansible.cfg` file to include the script as the default inventory source:

```ini
[defaults]
inventory = ./docker_inventory.py
```

With this configuration, you no longer need to specify the `-i` option every time you run a playbook. Ansible will automatically use the `docker_inventory.py` script to generate the inventory.

### Step 5: Advanced Customization

You can further customize the script to include additional functionality, such as:

- **Group Containers by Labels**: Modify the script to group containers based on Docker labels. This is useful if you want to apply different roles or tasks to different sets of containers.
  
- **Include Additional Variables**: Pull more information from the Docker API (e.g., container IP addresses, environment variables) and include them in the inventory. This can be done by enhancing the `list_containers()` function to fetch more details.

- **Error Handling**: Add error handling to manage scenarios where Docker is not running, or no containers are available.

### Summary

Using a custom dynamic inventory script like the `docker_inventory.py` script allows you to seamlessly manage and automate Docker containers with Ansible. This approach is flexible and can be tailored to fit complex or specialized environments that are not covered by Ansible's default inventory plugins. By following the steps above, you can easily integrate and use this script within your Ansible workflows.

## Grouping Strategies: Nested Groups and Host Patterns

Grouping hosts effectively is crucial for applying roles, playbooks, and variables across different sections of your infrastructure.

### 1. Nested Groups
Nested groups allow you to create hierarchical structures within your inventory. This is useful for applying different configurations at various levels.

- **Example**:
  ```yaml
  all:
    children:
      webservers:
        children:
          nginx_servers:
            hosts:
              web01:
              web02
          apache_servers:
            hosts:
              web03
      dbservers:
        hosts:
          db01:
          db02
  ```

### 2. Host Patterns
Host patterns are a powerful way to target specific hosts within your inventory. Ansible supports various pattern types, such as unions, intersections, and exclusions.

- **Examples**:
  - Target all web servers:
    ```yaml
    - hosts: webservers
    ```
  - Target all but Apache servers:
    ```yaml
    - hosts: webservers:!apache_servers
    ```
  - Target specific hosts by name:
    ```yaml
    - hosts: web01:web02
    ```

## Leveraging Inventory Plugins for Complex Environments

Ansible inventory plugins extend the capabilities of inventories beyond the basic static and dynamic types. These plugins are particularly useful in complex environments where custom data sources or specific organizational requirements are involved.

### 1. External Inventory Plugins
External inventory plugins can be used to pull inventory data from various sources, such as REST APIs, databases, or external files.

- **Example: JSON File Plugin**:
  - The `constructed` plugin allows you to construct inventory based on an external JSON file:
  ```yaml
  plugin: constructed
  hosts:
    plugin: jsonfile
    file: /path/to/your/inventory.json
  groups:
    webservers: "'web' in inventory_hostname"
  ```

### 2. Combining Multiple Plugins
You can combine multiple plugins to create a hybrid inventory that draws from different data sources.

- **Example: Combining AWS EC2 and Static Inventory**:
  ```yaml
  plugin: aws_ec2
  regions:
    - us-east-1
  compose:
    ansible_host: public_ip_address
  groups:
    aws_instances: "'tag:Role' in tags"
  ```
  - You can also include a static inventory file in the same directory, and Ansible will merge them during execution.

By utilizing these advanced inventory techniques, you can ensure that your Ansible playbooks and roles are applied accurately across diverse and dynamic infrastructures. This level of flexibility and control is essential for managing complex environments efficiently.

---

This completes Section 3 on advanced inventory techniques. Let me know if you'd like to proceed with another section or need any adjustments!